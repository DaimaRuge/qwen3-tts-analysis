# Microsoft Agent Framework - 架构图索引

## 架构图文件说明

本目录包含 Microsoft Agent Framework 的技术架构图，配合主报告阅读。

## 文件列表

- `architecture-overview.png` - 整体架构分层图
- `agent-class-diagram.png` - Agent 类继承图
- `module-dependency.png` - 模块依赖关系图
- `orchestration-flow.png` - 编排流程图

## 查看方式

架构图使用 Mermaid/PlantUML 语法定义，可在支持的工具中渲染。

---

## 架构图 Mermaid 源码

### 1. 整体架构分层

```mermaid
graph TB
    subgraph 应用层
        A1[Chat Agents]
        A2[Multi-Agent Workflows]
        A3[Workflow Apps]
    end
    
    subgraph 编排层
        B1[Sequential]
        B2[Concurrent]
        B3[GroupChat]
        B4[Handoff]
    end
    
    subgraph Agent核心层
        C1[Agent Core]
        C2[Tools]
        C3[Memory]
    end
    
    subgraph 客户端适配层
        D1[OpenAI]
        D2[Azure]
        D3[Anthropic]
        D4[Ollama]
    end
    
    subgraph 基础设施层
        E1[Middleware]
        E2[Telemetry]
        E3[MCP]
    end
    
    A1 --> C1
    A2 --> B1
    A3 --> B2
    B1 --> C1
    C1 --> D1
    C2 --> E1
    C3 --> E2
    D1 --> E3
```

### 2. Agent 类继承体系

```mermaid
classDiagram
    class SupportsAgentRun {
        +id: str
        +name: str
        +run(messages, stream)
        +get_new_thread()
    }
    
    class BaseAgent {
        +id: str
        +name: str
        +description: str
        +context_provider
        +middleware
        +get_new_thread()
        +as_tool()
    }
    
    class RawAgent {
        +client: SupportsChatGetResponse
        +instructions: str
        +tools: list
        +default_options: dict
        +run()
        +as_mcp_server()
    }
    
    class Agent {
        +telemetry_layer
        +middleware_pipeline
    }
    
    SupportsAgentRun <|.. BaseAgent
    BaseAgent <|-- RawAgent
    RawAgent <|-- Agent
```

### 3. 请求处理流程

```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant Middleware
    participant Client
    participant LLM
    
    User->>Agent: run(messages)
    Agent->>Middleware: process_request()
    Middleware->>Client: get_response()
    Client->>LLM: API Call
    LLM-->>Client: Response
    Client-->>Middleware: ChatResponse
    Middleware-->>Agent: process_response()
    Agent-->>User: AgentResponse
```

### 4. 工具调用流程

```mermaid
sequenceDiagram
    participant Agent
    participant LLM
    participant ToolInvocation
    participant Tools
    
    Agent->>LLM: send with tools
    LLM-->>Agent: tool_calls
    
    loop For each tool call
        Agent->>ToolInvocation: invoke(function, args)
        ToolInvocation->>Tools: execute
        Tools-->>ToolInvocation: result
        ToolInvocation-->>Agent: result
    end
    
    Agent->>LLM: send results
    LLM-->>Agent: final response
```

### 5. 编排模式对比

```mermaid
flowchart LR
    subgraph Sequential
        S1[A] --> S2[B] --> S3[C]
    end
    
    subgraph Concurrent
        C1[A] --> C2[B]
        C1 --> C3[C]
        C2 --> C4[D]
        C3 --> C4
    end
    
    subgraph GroupChat
        G1[A] <--> G2[B]
        G2 <--> G3[C]
        G3 <--> G1
    end
    
    subgraph Handoff
        H1[A] -.->|handoff| H2[B]
        H2 -.->|handoff| H3[C]
    end
```

---

## 架构要点速览

### 核心设计原则

1. **协议优先** - 使用 Python Protocol 实现灵活扩展
2. **分层清晰** - 核心/编排/应用三层分离
3. **类型安全** - 泛型参数确保编译时检查
4. **异步原生** - 全链路 async/await 支持

### 关键抽象

| 抽象 | 职责 |
|------|------|
| SupportsAgentRun | Agent 行为协议 |
| SupportsChatGetResponse | 客户端能力协议 |
| BaseChatClient | 客户端抽象基类 |
| FunctionTool | 工具封装 |
| AgentThread | 对话状态管理 |

---

*生成时间: 2026-02-12*
